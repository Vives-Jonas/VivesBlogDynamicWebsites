@attribute [Route(AppRoutes.Blog.Create)]


@using VivesBlog.Dto.Requests

@inject PersonSdkService PersonSdkService
@inject BlogSdkService BlogSdkService

@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<MudPaper Class="p-6 mx-auto" MaxWidth="600px" Elevation="2">

    <MudText Typo="Typo.h5" Class="mb-4">Create Blog Post</MudText>
    @if (Model is null || Authors is null)
    {
        <MudOverlay Visible="true" DarkBackground="true" ZIndex="9999">
            <MudProgressCircular Color="Color.Secondary" Indeterminate="true" />
        </MudOverlay>
    }
    else {

    <EditForm Model="@Model" OnValidSubmit="OnValidSubmit">
            <ValidationSummary></ValidationSummary>
            <DataAnnotationsValidator></DataAnnotationsValidator>
        <!-- Title -->
        <MudTextField Label="Title"
                      For="@(() => Model.Title)"
                      @bind-Value="Model.Title"
                      Required="true"
                      RequiredError="Title is required"
                      Class="mb-4" />

        <!-- Content -->
        <MudTextField Label="Content"
                      For="@(() => Model.Content)"
                      @bind-Value="Model.Content"
                      Lines="6"
                      TextFieldStyle="TextFieldStyle.Filled"
                      Required="true"
                      RequiredError="Content is required"
                      Class="mb-4" />

        <!-- Author -->
            <div>
                <label>
                    Function:

                    <InputSelect @bind-Value="Model.AuthorId">
                        <option value="No author"></option>
                        @foreach (var author in Authors)
                        {
                            <option value="@author.Id">@author.FirstName @author.LastName</option>
                        }
                    </InputSelect>

                </label>
            </div>
        <!-- Buttons -->
        <!-- Buttons -->
        <MudStack Row="true" Spacing="2">
            <MudButton ButtonType="ButtonType.Submit" Color="Color.Primary" Variant="Variant.Filled">
                Create
            </MudButton>

            <MudButton Color="Color.Secondary" Variant="Variant.Outlined" OnClick="Cancel">
                Cancel
            </MudButton>
        </MudStack>

    </EditForm>
    }
</MudPaper>


@code {
    

    private IList<PersonResult>? Authors { get; set; }

    private ArticleRequest? Model { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Model = new ArticleRequest
        {
            Title = string.Empty,
            Content = string.Empty,
        };

        await LoadAuthors();
        await base.OnInitializedAsync();
    }

    private async Task LoadAuthors() 
    {
        var result = await PersonSdkService.Find(new Vives.Services.Model.Paging());    
        Authors = result.Data.ToList();
    }

    private void Cancel()
    {
        Model = new ArticleRequest
        {
            Title = string.Empty,
            Content = string.Empty,
        };
    }

    private async Task OnValidSubmit()
    {
        if (Model is null)
        {
            return;
        }
        var result = await BlogSdkService.Create(Model);
        if (!result.IsSuccess)
        {
            var snackbarHtml = "<div>Failed to create Post</div><ul>";
            @foreach (var error in result.Messages)
            {
                snackbarHtml = $"{snackbarHtml}<li>{error.Description}</li>";
            }

            snackbarHtml = $"{snackbarHtml}</ul>";
            Snackbar.Add(new MarkupString(snackbarHtml));
            return;
        }

        NavigationManager.NavigateTo("/blog");
    }
}

